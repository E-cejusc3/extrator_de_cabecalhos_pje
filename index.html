<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extrator de Cabeçalhos PJe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #1f2937;
            --input-bg-color: #f9fafb;
            --input-border-color: #d1d5db;
            --primary-color: #3b82f6;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --card-bg: #ffffff;
            --card-border: #e5e7eb;
            --tab-bg: #e5e7eb;
            --tab-active-bg: #ffffff;
            --tab-active-text: #111827;
            --tab-inactive-text: #4b5563;
        }

        body.dark {
            --bg-color: #111827;
            --text-color: #e5e7eb;
            --input-bg-color: #1f2937;
            --input-border-color: #4b5563;
            --primary-color: #60a5fa;
            --secondary-color: #34d399;
            --danger-color: #f87171;
            --card-bg: #1f2937;
            --card-border: #374151;
            --tab-bg: #1f2937;
            --tab-active-bg: #374151;
            --tab-active-text: #f9fafb;
            --tab-inactive-text: #9ca3af;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            font-family: 'Inter', sans-serif;
        }

        /* --- Estilos do Extrator --- */
        #alert-box {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            background-color: var(--secondary-color);
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        #extrator-view textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            font-family: Arial, sans-serif;
            font-size: 16px;
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border: 1px solid var(--input-border-color);
            border-radius: 8px;
            padding: 8px;
        }

        .botao {
            border: none;
            color: #fff;
            padding: 10px 24px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 8px;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        .botao:hover {
            transform: translateY(-2px);
        }

        #extrairTextoCopiado { background-color: #2E8B57; }
        #limparCaixas { background-color: #F08080; }
        #copiarDados { background-color: #4682B4; }
        #gerarWord { background-color: #708090; }
        #extrairTextoCopiado:hover { background-color: #3CB371; }
        #limparCaixas:hover { background-color: #CD5C5C; }
        #copiarDados:hover { background-color: #5F9EA0; }
        #gerarWord:hover { background-color: #778899; }
        
        .tabela-dados-pje {
            width: 100%;
            max-width: 800px;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
        }
        .tabela-dados-pje td {
            border: 1px solid var(--card-border);
            padding: 10px;
        }
        .titulo-tabela { text-align: center; }
        .titulo-principal { text-decoration: underline; }

        /* --- Estilos das Abas --- */
        .tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            border-radius: 0.5rem 0.5rem 0 0;
            background-color: var(--tab-bg);
            color: var(--tab-inactive-text);
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
            border-bottom: none;
        }
        .tab-button.active {
            background-color: var(--card-bg);
            color: var(--tab-active-text);
            border-color: var(--card-border);
        }
        
        /* --- Estilos das Cláusulas --- */
        #clausulas-list {
            height: calc(100vh - 250px);
            overflow-y: auto;
        }
        #clausula-viewer {
             height: calc(100vh - 250px);
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .clausula-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .clausula-item.selected {
            background-color: var(--primary-color) !important;
            color: white !important;
        }

        /* --- Estilos do Editor de Cláusulas --- */
        #clause-editor-container { height: 250px; }
        .ql-toolbar { border-radius: 0.5rem 0.5rem 0 0; }
        .ql-container { border-radius: 0 0 0.5rem 0.5rem; font-size: 1rem; }
        body.dark .ql-snow .ql-stroke { stroke: var(--text-color); }
        body.dark .ql-snow .ql-fill, body.dark .ql-snow .ql-stroke.ql-thin { stroke: var(--text-color); }
        body.dark .ql-snow .ql-picker-label { color: var(--text-color); }
        body.dark .ql-toolbar { border-color: var(--input-border-color) !important; }
        body.dark .ql-container { border-color: var(--input-border-color) !important; }
        body.dark .ql-editor { color: var(--text-color); }
        body.dark .ql-snow .ql-picker-options { background-color: var(--card-bg); border-color: var(--input-border-color); }


        /* --- Estilos Gerais --- */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold">Extrator de Cabeçalhos PJe</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400">Extrator de Cabeçalhos e Gestor de Cláusulas</p>
        </div>
        <div class="fixed top-4 right-4 z-50 text-center flex items-center gap-4">
            <div id="Autor" class="text-xs text-gray-500 dark:text-gray-400 hidden sm:block">
                Filipe S. Lima | Gabriel F. Angst<br>e-CEJUSC 3/TJDFT | 13/10/25 13:55 <br><a href="https://tjdf.sharepoint.com/sites/eCEJUSC3/_layouts/15/stream.aspx?id=%2Fsites%2FeCEJUSC3%2FPasta%20de%20rede%2F04%20V%C3%ADdeos%20Instrut%C3%B3rios%2F07%2E%20Ferramentas%20Adicionais%2F01%20-%20Extrator%20PJe%2Emp4" target="_blank">❓ Como utilizar? </a>
            </div>
            <label>
                <input type="checkbox" id="theme-toggle" class="hidden">
                <span id="theme-label" class="cursor-pointer p-3 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center">
                    <i id="theme-icon" class="fas fa-moon"></i>
                </span>
            </label>
        </div>
    </header>

    <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
        <nav class="flex -mb-px" aria-label="Tabs">
            <button id="tab-extrator" class="tab-button active" onclick="showTab('extrator')">
                Extrator de Cabeçalhos
            </button>
            <button id="tab-clausulas" class="tab-button" onclick="showTab('clausulas')">
                Cláusulas Minutadas
            </button>
        </nav>
    </div>

    <main>
        <div id="extrator-view">
            <textarea id="caixa1" placeholder="Após abrir o cabeçalho do processo no PJe e copiar todos os dados apertando Ctrl+A e Ctrl+C, cole aqui ou clique no botão 'Extrair texto copiado'"></textarea>
            <textarea id="caixa2" class="hidden"></textarea>
            <textarea id="caixa3" class="hidden"></textarea>
            <textarea id="caixa4" class="hidden"></textarea>
            <textarea id="caixa5" class="hidden"></textarea>
            <textarea id="caixa6" class="hidden"></textarea>
            <textarea id="caixa7" class="hidden"></textarea>
            
            <div class="flex flex-wrap gap-2 mb-6">
                <button class="botao" id="extrairTextoCopiado" onclick="extrairClipboard()">Extrair texto copiado</button>
                <button class="botao" id="limparCaixas" onclick="limparCaixas()">Limpar Caixas</button>
                <button class="botao" id="copiarDados" onclick="copiarDadosFormatados()">Copiar Cabeçalho</button>
               <a href="antigo.html"> <button class="botao" id="gerarWord" type="button">Versão antiga</button></a>
</a> 
            </div>
      
            <div id="dados-para-copiar" class="space-y-6">
                <table class="tabela-dados-pje">
                    <tbody><tr><td>
                        <p class="titulo-tabela"><span class="titulo-principal">DADOS EXTRAÍDOS DO PJE</span></p>
                        <div id="output1"></div>
                    </td></tr></tbody>
                </table>
                <table class="tabela-dados-pje">
                    <tbody><tr><td>
                        <p class="titulo-tabela"><span class="titulo-principal">PARTICIPANTES DA AUDIÊNCIA</span></p>
                        <div id="output2"></div>
                    </td></tr></tbody>
                </table>
                <table class="tabela-dados-pje">
                    <tbody><tr><td>
                        <p class="titulo-tabela">
                            <span class="titulo-principal">DADOS DAS PARTES</span><br>
                            <span class="subtitulo-tabela text-xs">(Portaria Conjunta GPR, GPVP, GSVP e GC n.º 71/2013; e CPC, art. 319, II) </span>
                        </p>
                        <div id="output3"></div>
                    </td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="clausulas-view" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 flex flex-col gap-4">
                    <div class="relative">
                        <input type="text" id="search-clausulas" placeholder="Buscar cláusula..." class="w-full p-3 rounded-lg border bg-[var(--input-bg-color)] border-[var(--input-border-color)] pl-10">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div id="clausulas-list" class="bg-[var(--card-bg)] border border-[var(--card-border)] rounded-lg p-2 space-y-1">
                        </div>
                    <button id="incluir-clausula-btn" class="w-full p-3 text-white font-bold rounded-lg bg-[var(--secondary-color)] hover:opacity-90 transition-opacity">
                        <i class="fas fa-plus-circle mr-2"></i>Incluir / Gerenciar
                    </button>
                </div>

                <div class="md:col-span-2 bg-[var(--card-bg)] border border-[var(--card-border)] rounded-lg p-6">
                    <div id="clausula-viewer">
                        <div class="text-center text-gray-500 dark:text-gray-400">
                            <i class="fas fa-file-alt fa-3x mb-4"></i>
                            <p class="font-semibold">Selecione uma cláusula à esquerda para visualizar seu conteúdo aqui.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="alert-box"></div>

    <div id="password-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-2xl p-8 w-full max-w-sm m-4">
            <h3 class="text-xl font-semibold mb-4">Acesso Restrito</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Insira a senha para gerenciar as cláusulas.</p>
            <input type="password" id="password-input" class="w-full p-2 border border-[var(--input-border-color)] rounded-md bg-[var(--input-bg-color)]" placeholder="Senha">
            <p id="password-error" class="text-red-500 text-sm mt-2 hidden">Senha incorreta.</p>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal('password-modal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md hover:opacity-80">Cancelar</button>
                <button onclick="checkPassword()" class="px-4 py-2 bg-[var(--primary-color)] text-white rounded-md hover:opacity-80 font-semibold">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="manage-clause-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-[var(--card-bg)] rounded-lg shadow-2xl p-8 w-full max-w-4xl m-4 flex flex-col gap-6 max-h-[90vh]">
            <h3 class="text-2xl font-semibold">Gerenciar Cláusulas</h3>
            <form id="clause-form" class="flex flex-col gap-4">
                <input type="hidden" id="clause-id">
                <input type="text" id="clause-title" placeholder="Título da Cláusula" required class="w-full p-3 border border-[var(--input-border-color)] rounded-md bg-[var(--input-bg-color)]">
                <div id="clause-editor-container"></div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="resetClauseForm()" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md hover:opacity-80">Novo</button>
                    <button type="submit" class="px-4 py-2 bg-[var(--primary-color)] text-white rounded-md hover:opacity-80 font-semibold">Salvar Cláusula</button>
                </div>
            </form>
            <div class="border-t border-[var(--card-border)] pt-4 flex-grow overflow-y-auto">
                <h4 class="font-semibold mb-2">Cláusulas Existentes</h4>
                <div id="manage-clausulas-list" class="space-y-2">
                    </div>
            </div>
             <div class="flex justify-end pt-4 border-t border-[var(--card-border)]">
                <button type="button" onclick="closeModal('manage-clause-modal')" class="px-6 py-2 bg-gray-200 dark:bg-gray-600 rounded-md hover:opacity-80">Fechar</button>
            </div>
        </div>
    </div>

<script type="module">
    // Importações do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    // --- CONFIGURAÇÃO FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyB4Wx4yJq4xjU4Y0-DWJc2H7aWeBFQg7xk",
        authDomain: "extrator-clausulas.firebaseapp.com",
        databaseURL: "https://extrator-clausulas-default-rtdb.firebaseio.com",
        projectId: "extrator-clausulas",
        storageBucket: "extrator-clausulas.appspot.com",
        messagingSenderId: "530836265351",
        appId: "1:530836265351:web:97bfb9901b4c8d77989b22",
        measurementId: "G-P710G5CVT5"
    };
    
    // Inicialização do Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const clausesRef = ref(db, 'clauses');
    let allClauses = {};
    let quill = null;

    // --- LÓGICA GERAL E DE ABAS ---
    function initializeQuillEditor() {
        if (document.querySelector('#clause-editor-container .ql-editor')) {
            return; // Já inicializado
        }
        quill = new Quill('#clause-editor-container', {
            modules: {
                toolbar: [
                    [{ 'font': [] }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['clean']
                ]
            },
            theme: 'snow'
        });
    }

    window.showTab = (tabName) => {
        document.getElementById('extrator-view').classList.add('hidden');
        document.getElementById('clausulas-view').classList.add('hidden');
        document.getElementById('tab-extrator').classList.remove('active');
        document.getElementById('tab-clausulas').classList.remove('active');
        document.getElementById(`${tabName}-view`).classList.remove('hidden');
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    window.showAlert3s = (message) => {
        const alertBox = document.getElementById('alert-box');
        alertBox.textContent = message || 'Ação concluída com sucesso!';
        alertBox.style.display = 'block';
        setTimeout(() => {
            alertBox.style.display = 'none';
        }, 3000);
    }

    window.openModal = (modalId) => {
        document.getElementById(modalId).classList.replace('hidden', 'flex');
        if (modalId === 'manage-clause-modal') {
            initializeQuillEditor();
        }
    }
    window.closeModal = (modalId) => document.getElementById(modalId).classList.replace('flex', 'hidden');

    // --- LÓGICA DAS CLÁUSULAS ---
    document.getElementById('incluir-clausula-btn').addEventListener('click', () => openModal('password-modal'));
    window.checkPassword = () => {
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        if (passwordInput.value === '123') {
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            closeModal('password-modal');
            openModal('manage-clause-modal');
        } else {
            passwordError.classList.remove('hidden');
        }
    };

    const renderClauses = (filter = '') => {
        const listContainer = document.getElementById('clausulas-list');
        const manageListContainer = document.getElementById('manage-clausulas-list');
        listContainer.innerHTML = '';
        manageListContainer.innerHTML = '';
        const filteredClauses = Object.entries(allClauses).filter(([id, clause]) => 
            clause.title.toLowerCase().includes(filter.toLowerCase())
        ).sort(([, a], [, b]) => a.title.localeCompare(b.title));
        if (filteredClauses.length === 0) {
            const emptyMsg = `<div class="text-center text-sm text-gray-500 p-4">Nenhuma cláusula encontrada.</div>`;
            listContainer.innerHTML = emptyMsg;
            manageListContainer.innerHTML = emptyMsg;
            return;
        }
        filteredClauses.forEach(([id, clause]) => {
            const item = document.createElement('div');
            item.className = 'clausula-item p-3 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700';
            item.textContent = clause.title;
            item.dataset.id = id;
            item.onclick = () => selectClause(id);
            listContainer.appendChild(item);
            const manageItem = document.createElement('div');
            manageItem.className = 'flex justify-between items-center p-2 rounded-md bg-gray-100 dark:bg-gray-700';
            manageItem.innerHTML = `<span class="font-medium">${clause.title}</span><div class="flex gap-2"><button onclick="editClause('${id}')" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button><button onclick="deleteClause('${id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></div>`;
            manageListContainer.appendChild(manageItem);
        });
    }
    
    window.selectClause = (id) => {
        const clause = allClauses[id];
        if (!clause) return;
        document.querySelectorAll('.clausula-item').forEach(el => el.classList.remove('selected'));
        const selectedElement = document.querySelector(`.clausula-item[data-id="${id}"]`);
        if (selectedElement) {
            selectedElement.classList.add('selected');
        }
        const viewer = document.getElementById('clausula-viewer');
        viewer.innerHTML = `<div class="flex justify-between items-center mb-4 pb-2 border-b border-[var(--card-border)]"><h3 class="text-2xl font-bold">${clause.title}</h3><button onclick="copyClauseContent()" class="botao flex items-center" style="background-color: var(--primary-color);"><i class="fas fa-copy mr-2"></i>Copiar</button></div><div id="clause-content-display" class="prose dark:prose-invert max-w-none">${clause.content}</div>`;
    }

    document.getElementById('search-clausulas').addEventListener('input', (e) => {
        renderClauses(e.target.value);
    });

    document.getElementById('clause-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('clause-id').value;
        const title = document.getElementById('clause-title').value;
        const content = quill.root.innerHTML;
        if (title.trim() === '' || content === '<p><br></p>') {
            showAlert3s('O título e o conteúdo não podem estar vazios.');
            return;
        }
        const clauseData = { title, content };
        try {
            if (id) {
                await set(ref(db, `clauses/${id}`), clauseData);
                showAlert3s('Cláusula atualizada com sucesso!');
            } else {
                await push(clausesRef, clauseData);
                showAlert3s('Cláusula criada com sucesso!');
            }
            resetClauseForm();
        } catch (error) {
            console.error("Erro ao salvar cláusula: ", error);
            showAlert3s('Erro ao salvar. Tente novamente.');
        }
    });

    window.resetClauseForm = () => {
        document.getElementById('clause-form').reset();
        document.getElementById('clause-id').value = '';
        if (quill) {
            quill.setContents([]);
        }
    }

    window.editClause = (id) => {
        const clause = allClauses[id];
        if (!clause) return;
        document.getElementById('clause-id').value = id;
        document.getElementById('clause-title').value = clause.title;
        if (quill) {
             quill.clipboard.dangerouslyPasteHTML(clause.content);
        }
    }

    window.deleteClause = async (id) => {
        if (confirm('Tem certeza que deseja excluir esta cláusula?')) {
            try {
                await remove(ref(db, `clauses/${id}`));
                showAlert3s('Cláusula excluída com sucesso!');
            } catch (error) {
                console.error("Erro ao excluir: ", error);
                showAlert3s('Erro ao excluir. Tente novamente.');
            }
        }
    }

    onValue(clausesRef, (snapshot) => {
        allClauses = snapshot.val() || {};
        renderClauses(document.getElementById('search-clausulas').value);
    });

    window.copyClauseContent = () => {
        const contentElement = document.getElementById('clause-content-display');
        if (!contentElement) {
            showAlert3s('Nenhum conteúdo para copiar.');
            return;
        }
        const htmlContent = contentElement.innerHTML;
        const contentToCopy = `<div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 20pt; text-align: justify;">${htmlContent}</div>`;
        const blob = new Blob([contentToCopy], { type: 'text/html' });
        const clipboardItem = new ClipboardItem({ 'text/html': blob });
        navigator.clipboard.write([clipboardItem]).then(() => {
            showAlert3s('Conteúdo da cláusula copiado! Lembre-se de alterar a forma de colar no Word para "Manter a formatação original"');
        }).catch(err => {
            console.error('Falha ao copiar conteúdo: ', err);
            showAlert3s('Erro ao copiar o conteúdo.');
        });
    };

    // --- LÓGICA DO EXTRATOR DE CABEÇALHOS ---
    window.extrairClipboard = () => {
        navigator.clipboard.readText().then(text => {
            document.getElementById('caixa1').value = text;
            processarCaixas();
        }).catch(err => {
            console.error('Falha ao ler da área de transferência: ', err);
            showAlert3s('Erro ao acessar a área de transferência.');
        });
    }

    window.limparCaixas = () => {
        for (let i = 1; i <= 7; i++) {
            document.getElementById('caixa' + i).value = '';
        }
        document.getElementById('output1').innerHTML = '';
        document.getElementById('output2').innerHTML = '';
        document.getElementById('output3').innerHTML = '';
    }

    // ===================================================================
    // FUNÇÃO DE COPIAR CABEÇALHO CORRIGIDA
    // ===================================================================
    window.copiarDadosFormatados = () => {
    const output1 = document.getElementById('output1').innerHTML;
    const output2 = document.getElementById('output2').innerHTML;
    const output3 = document.getElementById('output3').innerHTML;

    if (!output1 && !output2 && !output3) {
        showAlert3s('Não há dados para copiar.');
        return;
    }

    const htmlString = `
        <div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt;">
            <table style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                <tbody>
                    <tr>
                        <td style="border: 1px solid black; padding: 5pt; line-height: 18pt;">
                            <p style="text-align: center; font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt;"><strong style="text-decoration: underline;">DADOS EXTRAÍDOS DO PJE</strong></p>
                            <div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt;">${output1}</div>
                        </td>
                    </tr>
                </tbody>
            </table>
            <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0;">&nbsp;</p>
            <table style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                <tbody>
                    <tr>
                        <td style="border: 1px solid black; padding: 5pt; line-height: 18pt;">
                            <p style="text-align: center; font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt;"><strong style="text-decoration: underline;">PARTICIPANTES DA AUDIÊNCIA</strong></p>
                            <div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt;">${output2}</div>
                        </td>
                    </tr>
                </tbody>
            </table>
            <p style="font-family: Arial, sans-serif; font-size: 6pt; margin: 0; padding: 0;">&nbsp;</p>
            <table style="border-collapse: collapse; width: 100%; border: 1px solid black;">
                <tbody>
                    <tr>
                        <td style="border: 1px solid black; padding: 5pt; line-height: 18pt;">
                            <p style="text-align: center; font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt;">
                                <strong style="text-decoration: underline;">DADOS DAS PARTES</strong><br>
                                <span style="font-size: 9pt;">(Portaria Conjunta GPR, GPVP, GSVP e GC n.º 71/2013; e CPC, art. 319, II)</span>
                            </p>
                            <div style="font-family: Arial, sans-serif; font-size: 12pt; line-height: 18pt;">${output3}</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;

    const blob = new Blob([htmlString], { type: 'text/html' });
    const clipboardItem = new ClipboardItem({ 'text/html': blob });

    navigator.clipboard.write([clipboardItem]).then(() => {
        showAlert3s('Cabeçalho copiado com sucesso! Lembre-se de alterar a forma de colar no Word para "Manter a formatação original"');
    }).catch(err => {
        console.error('Falha ao copiar o cabeçalho: ', err);
        showAlert3s('Erro ao copiar o cabeçalho.');
    });
};
    // ===================================================================
    // FIM DA FUNÇÃO CORRIGIDA
    // ===================================================================

    window.processarCaixas = () => {
        const caixa1 = document.getElementById('caixa1').value.split('\n');
        if (caixa1.length > 1) {
            document.getElementById('caixa2').value = caixa1[1].replace(/[^\d\W]/g, '');
        }
        const orgaoJulgadorIndex = caixa1.findIndex(line => line.includes('Órgão julgador'));
        if (orgaoJulgadorIndex !== -1 && orgaoJulgadorIndex + 1 < caixa1.length) {
            document.getElementById('caixa3').value = caixa1[orgaoJulgadorIndex + 1];
        }
        const poloAtivoIndex = caixa1.findIndex(line => line.includes('Polo ativo'));
        const poloPassivoIndex = caixa1.findIndex(line => line.includes('Polo passivo'));
        if (poloAtivoIndex !== -1 && poloPassivoIndex !== -1 && poloAtivoIndex < poloPassivoIndex) {
            const requerentes = caixa1.slice(poloAtivoIndex + 1, poloPassivoIndex).filter(line => !line.startsWith(' ')).map(line => line.replace('Parte cadastrada no Domicilio Judicial Eletrônico - Resolução CNJ Nº 455 de 27/04/2022 ', '')).filter(line => !line.includes('Procuradoria cadastrada no'));
            document.getElementById('caixa4').value = requerentes.join('\n');
        }
        const iconeDownloadIndex = caixa1.findIndex(line => line.includes('Ícone de download'));
        if (poloPassivoIndex !== -1 && iconeDownloadIndex !== -1 && iconeDownloadIndex > poloPassivoIndex) {
            // <!-- ATUALIZAÇÃO 1: Inclui "REQUERIDO ESPÓLIO DE" na filtragem de réus -->
            const requeridos = caixa1.slice(poloPassivoIndex + 1, iconeDownloadIndex).filter(line => /(REQUERIDO|RÉU|REU|EXECUTADO|EMBARGADO|REQUERIDO ESPÓLIO DE)\)$/.test(line.trim())).map(line => line.replace('Parte cadastrada no Domicilio Judicial Eletrônico - Resolução CNJ Nº 455 de 27/04/2022 ', ''));
            document.getElementById('caixa6').value = requeridos.join('\n');
        }
        document.getElementById('caixa5').value = formatarRequerentes(document.getElementById('caixa4').value.split('\n'));
        document.getElementById('caixa7').value = formatarRequeridos(document.getElementById('caixa6').value.split('\n'));
        atualizarOutputs();
    }

    const formatarRequerentes = (requerentes) => {
        if (requerentes.length === 1) {
            // <!-- ATUALIZAÇÃO 2: Inclui "REQUERENTE ESPÓLIO DE" na formatação de autores -->
            return `<b>Requerente:</b> ${requerentes[0].replace(/ \((REQUERENTE|AUTOR|EXEQUENTE|AUTORA|EMBARGANTE|REQUERENTE ESPÓLIO DE)\)/g, '')}`;
        }
        // <!-- ATUALIZAÇÃO 3: Inclui "REQUERENTE ESPÓLIO DE" na formatação de autores (lista) -->
        return requerentes.map((req, index) => `<b>${index + 1}º Requerente:</b> ${req.replace(/ \((REQUERENTE|AUTOR|EXEQUENTE|AUTORA|EMBARGANTE|REQUERENTE ESPÓLIO DE)\)/g, '')}`).join('\n');
    }

    const formatarRequeridos = (requeridos) => {
        if (requeridos.length === 1) {
            // <!-- ATUALIZAÇÃO 4: Inclui "REQUERIDO ESPÓLIO DE" na formatação de réus -->
            return `<b>Requerido(a):</b> ${requeridos[0].replace(/ \((REQUERIDO|RÉU|REU|EXECUTADO|EMBARGADO|REQUERIDO ESPÓLIO DE)\)/g, '')}`;
        }
        // <!-- ATUALIZAÇÃO 5: Inclui "REQUERIDO ESPÓLIO DE" na formatação de réus (lista) -->
        return requeridos.map((req, index) => `<b>${index + 1}º Requerido(a):</b> ${req.replace(/ \((REQUERIDO|RÉU|REU|EXECUTADO|EMBARGADO|REQUERIDO ESPÓLIO DE)\)/g, '')}`).join('\n');
    }

    const atualizarOutputs = () => {
        const caixa4 = document.getElementById('caixa4').value.split('\n');
        const caixa6 = document.getElementById('caixa6').value.split('\n');
        const hasExequente = caixa4.some(line => /\(EXEQUENTE\)$/.test(line.trim()));
        const hasExecutado = caixa6.some(line => /\(EXECUTADO\)$/.test(line.trim()));
        const hasEmbargante = caixa4.some(line => /\(EMBARGANTE\)$/.test(line.trim()));
        const hasEmbargado = caixa6.some(line => /\(EMBARGADO\)$/.test(line.trim()));
        const exequenteTermo = hasExequente ? 'Exequente' : hasEmbargante ? 'Embargante' : 'Requerente';
        const executadoTermo = hasExecutado ? 'Executado(a)' : hasEmbargado ? 'Embargado(a)' : 'Requerido(a)';
        const exequenteParte = hasExequente ? 'EXEQUENTE' : hasEmbargante ? 'EMBARGANTE' : 'REQUERENTE';
        const executadoParte = hasExecutado ? 'EXECUTADA' : hasEmbargado ? 'EMBARGADA' : 'REQUERIDA';
        const caixa8 = `<b>Juízo:</b> ${document.getElementById('caixa3').value}\n` +
            `<b>Processo:</b> ${document.getElementById('caixa2').value}\n` +
            `${document.getElementById('caixa5').value.replace(/Requerente:/g, `${exequenteTermo}:`)}\n` +
            `${document.getElementById('caixa7').value.replace(/Requerido\(a\):/g, `${executadoTermo}:`)}`;
        const caixa9 = caixa8.split('\n').slice(2).map(line => `${line.trim()}<br><b>Telefone:</b> Número<br><b>Preposto(a):</b> nome completo, <b>CPF:</b> número, <b>telefone:</b> número (<b>Carta de preposto ID n. xxxx</b>).<br><b>Advogado(a):</b> nome completo, <b>OAB/DF:</b> número, <b>telefone:</b> número (<b>Procuração ID xxxx</b>).<br><br>`).join('').replace(/^\s+/gm, '');
        const textoAdicional = `<b>Observador(es):</b> Nome completo, CPF, (...), que assume(m) o dever de confidencialidade (CPC, art. 166, § 1º).<br><br><b>Conciliador(es)/Mediador(es):</b> Nome completo &emsp; <b>Sala:</b> número da sala<br><br><b>Supervisor(es):</b> Nome se houver e <b>Matrícula:</b> número`;
        const formatBold = text => text.replace(/(CPF:|CNPJ:)/g, '<b>$1</b>');
        document.getElementById('output1').innerHTML = formatBold(caixa8).replace(/\n/g, '<br>');
        document.getElementById('output2').innerHTML = formatBold(caixa9 + textoAdicional);
        
        // <!-- ATUALIZAÇÃO 6: Inclui "REQUERENTE ESPÓLIO DE" na limpeza para o output3 -->
        const requerentes = caixa4.map(req => req.replace(/ \((REQUERENTE|AUTOR|EXEQUENTE|AUTORA|EMBARGANTE|REQUERENTE ESPÓLIO DE)\)/g, '').trim());
        // <!-- ATUALIZAÇÃO 7: Inclui "REQUERIDO ESPÓLIO DE" na limpeza para o output3 -->
        const requeridos = caixa6.map(req => req.replace(/ \((REQUERIDO|RÉU|REU|EXECUTADO|EMBARGADO|REQUERIDO ESPÓLIO DE)\)/g, '').trim());
        
        let output3Content = '';
        requerentes.forEach((req, index) => {
            const prefix = requerentes.length > 1 ? `A parte ${index + 1}ª ${exequenteParte}` : `A parte ${exequenteParte}`;
            const type = req.includes('CNPJ:') ? 'pessoa jurídica estabelecida no(a)' : 'residente e domiciliado(a)';
            output3Content += `<p><b>${prefix}: ${req}</b>, ${type} xxxx, telefone xxxx e e-mail xxxx.</p>`;
        });
         requeridos.forEach((req, index) => {
            const prefix = requeridos.length > 1 ? `A parte ${index + 1}ª ${executadoParte}` : `A parte ${executadoParte}`;
            const type = req.includes('CNPJ:') ? 'pessoa jurídica estabelecida no(a)' : 'residente e domiciliado(a)';
            output3Content += `<p><b>${prefix}: ${req}</b>, ${type} xxxx, telefone xxxx e e-mail xxxx.</p>`;
        });
        document.getElementById('output3').innerHTML = output3Content;
    }

    function gerarWord() {
    var urlDeRedirecionamento = "https://e-cejusc3.github.io/extrator_de_cabecalhos_pje/antigo.html";
    
    // Esta linha faz o redirecionamento.
    window.location.href = urlDeRedirecionamento; 
}

    // --- TEMA CLARO/ESCURO ---
    const themeToggle = document.getElementById("theme-toggle");
    const themeIcon = document.getElementById("theme-icon");
    const body = document.body;
    const savedTheme = localStorage.getItem("theme") || "light";
    body.classList.toggle("dark", savedTheme === "dark");
    themeIcon.className = savedTheme === "dark" ? "fas fa-sun" : "fas fa-moon";
    themeToggle.addEventListener("change", () => {
        const isDark = body.classList.toggle("dark");
        themeIcon.className = isDark ? "fas fa-sun" : "fas fa-moon";
        localStorage.setItem("theme", isDark ? "dark" : "light");
    });
</script>
</body>
</html>
